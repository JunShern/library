<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Branch Loans - Buku-Buka</title>
  <link rel="icon" type="image/png" href="assets/app_icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&family=PT+Serif:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="has-hero-bg has-hero-bg--manage">
  <main class="container">
    <div id="messages"></div>

    <div class="page-header">
      <h1>Manage Loans</h1>
    </div>

    <div class="filters mb-2">
      <select id="branch-filter">
        <option value="">All My Branches</option>
      </select>
      <select id="status-filter">
        <option value="active">Active</option>
        <option value="overdue">Overdue</option>
        <option value="returned">Returned</option>
        <option value="">All</option>
      </select>
    </div>

    <div id="loans-content">
      <div class="loading">
        <div class="spinner"></div>
        <p>Loading loans...</p>
      </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
      <div class="card" style="width: 400px; max-width: 90%;">
        <div class="card-body">
          <h3>Check Out Book</h3>
          <p id="checkout-book-title" class="mb-2"></p>

          <div class="form-group">
            <label for="borrower-search">Borrower</label>
            <div class="searchable-select" id="borrower-select-container">
              <input type="text" id="borrower-search" placeholder="Search for a borrower..." autocomplete="off">
              <input type="hidden" id="borrower-select" required>
              <div class="searchable-select-dropdown" id="borrower-dropdown"></div>
            </div>
          </div>

          <div class="form-group">
            <label for="due-date">Due Date</label>
            <input type="date" id="due-date" required>
          </div>

          <div class="form-group">
            <label for="loan-notes">Notes (optional)</label>
            <textarea id="loan-notes" rows="2"></textarea>
          </div>

          <div class="mt-2">
            <button id="confirm-checkout" class="btn btn-primary">Check Out</button>
            <button id="cancel-checkout" class="btn btn-secondary">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/api.js"></script>
  <script src="js/components.js"></script>
  <script>
    let userBranches = [];
    let currentCheckoutCopyId = null;

    async function init() {
      if (!auth.isAuthenticated() || !auth.isBranchOwner()) {
        window.location.href = 'login.html?return=branch-loans.html';
        return;
      }

      await loadBranches();
      await loadBorrowers();
      initBorrowerSearch();
      await loadLoans();

      // Check for checkout param
      const params = new URLSearchParams(window.location.search);
      const checkoutCopyId = params.get('checkout');
      if (checkoutCopyId) {
        showCheckoutModal(checkoutCopyId);
      }
    }

    async function loadBranches() {
      try {
        const response = await api.getBranches();
        userBranches = response.branches.filter(b =>
          b.owner?.id === auth.user?.id || auth.isAdmin()
        );

        const select = document.getElementById('branch-filter');
        userBranches.forEach(branch => {
          const option = document.createElement('option');
          option.value = branch.id;
          option.textContent = branch.name;
          select.appendChild(option);
        });

        // Set default from URL
        const params = new URLSearchParams(window.location.search);
        const branchId = params.get('branch');
        if (branchId) {
          select.value = branchId;
        }
      } catch (err) {
        showMessage('Error loading branches: ' + err.message);
      }
    }

    let allBorrowers = [];

    async function loadBorrowers() {
      try {
        const response = await api.getUsers();
        // Deduplicate users by ID
        const seen = new Set();
        allBorrowers = response.users.filter(user => {
          if (seen.has(user.id)) return false;
          seen.add(user.id);
          return true;
        }).map(user => ({
          id: user.id,
          name: user.name || user.email,
          email: user.email
        }));
      } catch (err) {
        console.log('Could not load users list');
      }
    }

    function initBorrowerSearch() {
      const searchInput = document.getElementById('borrower-search');
      const hiddenInput = document.getElementById('borrower-select');
      const dropdown = document.getElementById('borrower-dropdown');

      function renderDropdown(filter = '') {
        const filterLower = filter.toLowerCase();
        const filtered = allBorrowers.filter(b =>
          b.name && b.name.toLowerCase().includes(filterLower)
        );

        if (filtered.length === 0) {
          dropdown.innerHTML = '<div class="searchable-select-item disabled">No matches found</div>';
        } else {
          dropdown.innerHTML = filtered.map(b => `
            <div class="searchable-select-item" data-id="${b.id}" data-name="${b.name}">${b.name}</div>
          `).join('');
        }
        dropdown.classList.add('show');
      }

      searchInput.addEventListener('focus', () => renderDropdown(searchInput.value));
      searchInput.addEventListener('input', (e) => {
        hiddenInput.value = '';
        renderDropdown(e.target.value);
      });

      dropdown.addEventListener('click', (e) => {
        const item = e.target.closest('.searchable-select-item');
        if (item && !item.classList.contains('disabled')) {
          hiddenInput.value = item.dataset.id;
          searchInput.value = item.dataset.name;
          dropdown.classList.remove('show');
        }
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('#borrower-select-container')) {
          dropdown.classList.remove('show');
        }
      });
    }

    async function loadLoans() {
      const content = document.getElementById('loans-content');
      showLoading(content);

      try {
        const params = {};
        const branch = document.getElementById('branch-filter').value;
        const status = document.getElementById('status-filter').value;

        if (branch) params.branch_id = branch;
        if (status) params.status = status;

        const response = await api.getLoans(params);
        renderLoans(response.loans);
      } catch (err) {
        content.innerHTML = `<div class="message message-error">${err.message}</div>`;
      }
    }

    function renderLoans(loans) {
      const content = document.getElementById('loans-content');

      if (loans.length === 0) {
        showEmpty(content, 'No loans found');
        return;
      }

      content.innerHTML = `
        <table class="loans-table">
          <thead>
            <tr>
              <th>Book</th>
              <th>Title</th>
              <th>Borrower</th>
              <th>Branch</th>
              <th>Borrowed</th>
              <th>Due Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${loans.map(loan => {
              const book = loan.copy?.book || {};
              const branch = loan.copy?.branch || {};
              const borrower = loan.borrower || {};
              const overdue = !loan.returned_at && isOverdue(loan.due_date);

              return `
                <tr>
                  <td data-label="Book" class="loan-book-cell">
                    <a href="book.html?id=${book.id}">
                      <img src="${book.cover_url || 'assets/placeholder_book.png'}"
                           alt="${book.title || 'Book cover'}"
                           class="loan-book-cover"
                           onerror="this.src='assets/placeholder_book.png'">
                    </a>
                    <div class="loan-book-info">
                      <a href="book.html?id=${book.id}">${book.title || 'Unknown'}</a>
                      <div class="text-muted">${book.author || ''}</div>
                    </div>
                  </td>
                  <td data-label="Title" class="loan-title-cell">
                    <span class="loan-title">${book.title || 'Unknown'}</span>
                    <span class="loan-author text-muted">${book.author || ''}</span>
                  </td>
                  <td data-label="Borrower">${borrower.name || borrower.email || 'Unknown'}</td>
                  <td data-label="Branch">${branch.name || 'Unknown'}</td>
                  <td data-label="Borrowed">${formatDate(loan.borrowed_at)}</td>
                  <td data-label="Due Date" class="${overdue ? 'overdue' : ''}">${formatDate(loan.due_date)}${overdue ? ' <span class="badge badge-unavailable">Overdue</span>' : ''}</td>
                  <td data-label="Actions">
                    ${loan.returned_at
                      ? `<span class="badge badge-available">Returned ${formatDate(loan.returned_at)}</span>`
                      : `<button class="btn btn-success btn-sm" data-loan="${loan.id}" data-title="${(book.title || 'this book').replace(/"/g, '&quot;')}" data-branch="${(branch.name || 'Unknown').replace(/"/g, '&quot;')}" onclick="returnLoan(this.dataset.loan, this.dataset.title, this.dataset.branch)">Return</button>`
                    }
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }

    async function showCheckoutModal(copyId) {
      currentCheckoutCopyId = copyId;

      try {
        const copy = await api.getCopy(copyId);
        document.getElementById('checkout-book-title').textContent =
          `${copy.book?.title || 'Unknown'} at ${copy.branch?.name || 'Unknown'}`;

        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + CONFIG.DEFAULT_LOAN_DAYS);
        document.getElementById('due-date').value = dueDate.toISOString().split('T')[0];

        document.getElementById('checkout-modal').classList.remove('hidden');
        document.getElementById('checkout-modal').style.display = 'flex';
      } catch (err) {
        showMessage('Error loading copy: ' + err.message);
      }
    }

    function hideCheckoutModal() {
      document.getElementById('checkout-modal').classList.add('hidden');
      document.getElementById('checkout-modal').style.display = 'none';
      currentCheckoutCopyId = null;

      // Clear borrower search
      document.getElementById('borrower-search').value = '';
      document.getElementById('borrower-select').value = '';
      document.getElementById('borrower-dropdown').classList.remove('show');

      const url = new URL(window.location);
      url.searchParams.delete('checkout');
      window.history.replaceState({}, '', url);
    }

    document.getElementById('cancel-checkout').addEventListener('click', hideCheckoutModal);

    document.getElementById('confirm-checkout').addEventListener('click', async () => {
      const borrowerId = document.getElementById('borrower-select').value;
      const dueDate = document.getElementById('due-date').value;
      const notes = document.getElementById('loan-notes').value;

      if (!borrowerId) {
        showMessage('Please select a borrower');
        return;
      }

      if (!dueDate) {
        showMessage('Please set a due date');
        return;
      }

      try {
        await api.createLoan({
          copy_id: currentCheckoutCopyId,
          borrower_id: borrowerId,
          due_date: dueDate,
          notes: notes || null,
        });

        showMessage('Book checked out successfully!', 'success');
        hideCheckoutModal();
        loadLoans();
      } catch (err) {
        showMessage('Error checking out: ' + err.message);
      }
    });

    async function returnLoan(loanId, bookTitle, branchName) {
      const confirmed = await showConfirmModal({
        title: 'Return Book',
        message: `Marking "${bookTitle}" as returned to the ${branchName} branch. Confirm?`,
        confirmText: 'Proceed',
        confirmClass: 'btn-success'
      });

      if (!confirmed) return;

      try {
        await api.returnLoan(loanId);
        showMessage('Book returned successfully!', 'success');
        loadLoans();
      } catch (err) {
        showMessage('Error returning book: ' + err.message);
      }
    }

    document.getElementById('branch-filter').addEventListener('change', loadLoans);
    document.getElementById('status-filter').addEventListener('change', loadLoans);

    // Initialize
    initHeader({
      activePage: 'branch-loans',
      onAuthChange: () => {
        if (auth.isAuthenticated() && auth.isBranchOwner()) {
          init();
        }
      }
    });
  </script>
</body>
</html>

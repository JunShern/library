<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Details - Buku-Buka</title>
  <link rel="icon" type="image/png" href="assets/app_icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&family=PT+Serif:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <main class="container">
    <div id="messages"></div>
    <div id="book-content">
      <div class="loading">
        <div class="spinner"></div>
        <p>Loading book details...</p>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/api.js"></script>
  <script src="js/components.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const bookId = params.get('id');

    async function loadBook() {
      const content = document.getElementById('book-content');

      if (!bookId) {
        content.innerHTML = '<div class="message message-error">No book ID provided</div>';
        return;
      }

      try {
        const book = await api.getBook(bookId);
        renderBook(book);
      } catch (err) {
        content.innerHTML = `<div class="message message-error">${err.message}</div>`;
      }
    }

    function renderBook(book) {
      const content = document.getElementById('book-content');
      document.title = `${book.title} - Buku-Buka`;

      const copies = book.copies || [];
      const copyGroups = {};
      copies.forEach(copy => {
        const branchName = copy.branch?.name || 'Unknown Branch';
        if (!copyGroups[branchName]) {
          copyGroups[branchName] = [];
        }
        copyGroups[branchName].push(copy);
      });

      content.innerHTML = `
        <div class="book-detail">
          <div class="book-detail-grid">
            <div class="book-detail-cover">
              <img src="${book.cover_url || 'assets/placeholder_book.png'}"
                   alt="${book.title}"
                   onerror="this.src='assets/placeholder_book.png'">
            </div>
            <div class="book-detail-info">
              <h1>${book.title}</h1>
            <div class="book-meta">
              ${book.author ? `<div><strong>Author:</strong> ${book.author}</div>` : ''}
              ${book.publisher ? `<div><strong>Publisher:</strong> ${book.publisher}</div>` : ''}
              ${book.publish_year ? `<div><strong>Year:</strong> ${book.publish_year}</div>` : ''}
              ${book.page_count ? `<div><strong>Pages:</strong> ${book.page_count}</div>` : ''}
              ${book.isbn ? `<div><strong>ISBN:</strong> ${book.isbn}</div>` : ''}
            </div>
            ${book.description ? `<div class="book-description">${book.description}</div>` : ''}
            </div>
          </div>
        </div>

        <div class="copies-list">
          <h2>Copies (${copies.length})</h2>
          ${copies.length > 0 ? `
            <div class="table-container">
              <table class="copies-table">
                <thead>
                  <tr>
                    <th>Location</th>
                    <th>Status</th>
                    ${auth.isBranchOwner() ? '<th></th>' : ''}
                  </tr>
                </thead>
                <tbody>
                  ${copies.map(copy => `
                    <tr>
                      <td>${copy.branch?.name || 'Unknown'}</td>
                      <td>
                        <span class="badge ${copy.is_available ? 'badge-available' : 'badge-unavailable'}">
                          ${copy.is_available ? 'Available' : 'On Loan'}
                        </span>
                        ${!copy.is_available && copy.current_loan ? `
                          <div class="text-muted text-sm">
                            Due: ${formatDate(copy.current_loan.due_date)}
                            ${isOverdue(copy.current_loan.due_date) ? '<span class="overdue">(Overdue)</span>' : ''}
                          </div>
                        ` : ''}
                      </td>
                      ${auth.isBranchOwner() ? `
                        <td>
                          ${copy.is_available ? `
                            <button class="btn btn-primary btn-sm" onclick="showCheckoutModal('${copy.id}')">
                              Check Out
                            </button>
                          ` : ''}
                        </td>
                      ` : ''}
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : '<p class="text-muted">No copies available</p>'}
        </div>

        ${auth.isAdmin() ? `
          <div class="admin-actions">
            <p class="text-muted text-sm">Admin</p>
            <button class="btn btn-danger btn-sm" onclick="deleteBook('${book.id}')">
              Delete Book
            </button>
          </div>
        ` : ''}
      `;
    }

    function showCheckoutModal(copyId) {
      window.location.href = `branch-loans.html?checkout=${copyId}`;
    }

    async function deleteBook(bookId) {
      if (!confirm('Are you sure you want to delete this book? This will also delete all copies and cannot be undone.')) {
        return;
      }

      try {
        await api.deleteBook(bookId);
        showMessage('Book deleted successfully', 'success');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 1000);
      } catch (err) {
        showMessage(err.message);
      }
    }

    // Initialize
    initHeader({ onAuthChange: loadBook });
    loadBook();
  </script>
</body>
</html>
